# Uni-Mol Representations

PolyglotMol provides a versatile interface to [Uni-Mol](https://github.com/dptech-corp/Uni-Mol), a powerful deep learning framework for 3D molecular modeling. It leverages the `unimol_tools` library to generate distinct types of molecular representations:

* **Molecule-level (CLS) embeddings**: A single vector representing the entire molecule, obtained via {py:class}`~polyglotmol.representations.spatial.unimol.UniMolCLSFeaturizer`.
* **Atom-level representations**: An embedding vector for each atom in the molecule, obtained via {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicReprsFeaturizer`.
* **Atomic 3D coordinates**: The spatial coordinates of each atom, typically generated by `unimol_tools`' internal conformer generation, obtained via {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicCoordsFeaturizer`.

These featurizers are designed to be 3D-aware. When provided with SMILES strings, `unimol_tools` will internally generate 3D conformers before featurization. Each specific featurizer variant (CLS, Coords, AtomicReprs) returns a single NumPy array, adhering to the standard PolyglotMol featurizer interface.

---
## Dependencies

To utilize UniMol featurizers within PolyglotMol, you'll need to install their core dependencies. You can install them together:

```bash
pip install unimol_tools huggingface_hub torch
```

Individual package details:
-   **`unimol_tools`**: The primary library for Uni-Mol model inference.
    -   **Repository**: [dptech-corp/Uni-Mol](https://github.com/dptech-corp/Uni-Mol) (Official project, often links to the tools)
-   **`huggingface_hub`**: Used by `unimol_tools` for downloading pre-trained model weights from the Hugging Face Hub.
    -   **Documentation**: [Hugging Face Hub Client Library](https://huggingface.co/docs/huggingface_hub/index)
-   **`torch` (PyTorch)**: The deep learning framework Uni-Mol models are built upon.
    -   **Installation**: See [PyTorch Official Website](https://pytorch.org/get-started/locally/) for instructions tailored to your system.

Models are typically downloaded automatically by `unimol_tools` (via `huggingface_hub`) to a local cache. For managing cache locations effectively with PolyglotMol, please refer to our guide on {doc}`../../basic/config`.

---
## Key Concepts

-   **Specialized Featurizers**: PolyglotMol offers distinct featurizer classes for each primary type of UniMol output:
    -   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolCLSFeaturizer`: For molecule-level embeddings. Returns a 1D NumPy array.
    -   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicCoordsFeaturizer`: For 3D atomic coordinates. Returns a 2D NumPy array of shape `(N_atoms, 3)`.
    -   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicReprsFeaturizer`: For atom-level embeddings. Returns a 2D NumPy array of shape `(N_atoms, D_embedding)`.
-   **Conformer Generation**: `unimol_tools` handles 3D conformer generation internally when SMILES strings are provided as input. The quality of these conformers can influence the resulting representations.
-   **Hydrogen Atom Handling**: The `remove_hs` parameter (configurable for each Uni-Mol model variant via `UNIMOL_BASE_CONFIGS` or by overriding it during featurizer instantiation using the `remove_hs_override` parameter) dictates whether hydrogen atoms are explicitly removed by `unimol_tools` before processing. This choice affects the number of atoms in atomic representations and coordinates.

---
## Usage

Access UniMol featurizers using their registered names with {py:func}`polyglotmol.representations.get_featurizer`. Each featurizer variant is registered with a descriptive key, detailed in the "Available Pre-registered Configurations" section.


::::{tab-set}

:::{tab-item} **CLS Representation (Molecule-Level)**

Use a `UniMol-CLS-...` featurizer key to get a single vector embedding for each molecule.

```python
from polyglotmol.representations import get_featurizer

cls_featurizer = get_featurizer("UniMol-CLS-unimolv2-84m-WithHs")

# Featurize a single SMILES string
smiles_ethanol = "CCO"
cls_embedding = cls_featurizer.featurize(smiles_ethanol)
print(f"Ethanol CLS Representation Shape: {cls_embedding.shape}")

# Featurize a batch of SMILES strings
smiles_batch = ["CC", "CCC", "c1ccccc1O"]
batch_cls_embeddings = cls_featurizer.featurize(smiles_batch, n_workers=1)

for i, emb in enumerate(batch_cls_embeddings):
    print(f"CLS Rep Shape for '{smiles_batch[i]}': {emb.shape}")
```

:::

:::{tab-item} **Atomic Coordinates (3D)**

Use a `UniMol-AtomicCoords-...` featurizer key to get the 3D coordinates for each atom.

```python
from polyglotmol.representations import get_featurizer

coords_featurizer = get_featurizer("UniMol-AtomicCoords-unimolv2-84m-WithHs")

smiles_acetic_acid = "CC(=O)O"
atomic_coordinates = coords_featurizer.featurize(smiles_acetic_acid)
print(f"Acetic Acid Atomic Coordinates Shape: {atomic_coordinates.shape}")
```

:::

:::{tab-item} **Atomic Representations (Atom-Level)**

Use a `UniMol-AtomicReprs-...` featurizer key to get an embedding vector for each atom.

```python
from polyglotmol.representations import get_featurizer

atomic_featurizer = get_featurizer("UniMol-AtomicReprs-unimolv2-84m-WithHs")

smiles_phenol = "c1ccccc1O"
atomic_representations = atomic_featurizer.featurize(smiles_phenol)
print(f"Phenol Atomic Representations Shape: {atomic_representations.shape}")
```

:::

::::


### Direct Instantiation (Advanced)
For more granular control over `unimol_tools.UniMolRepr` parameters not exposed by the pre-registered configurations, you can directly instantiate the specific featurizer classes:
{py:class}`~polyglotmol.representations.spatial.unimol.UniMolCLSFeaturizer`,
{py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicCoordsFeaturizer`, or
{py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicReprsFeaturizer`.

```python
from polyglotmol.representations.spatial.unimol import UniMolCLSFeaturizer 
# Or UniMolAtomicCoordsFeaturizer, UniMolAtomicReprsFeaturizer

# 'model_config_key' must match a key in UNIMOL_BASE_CONFIGS.
# This key determines the underlying UniMol model and its default 'remove_hs' setting.
custom_cls_featurizer = UniMolCLSFeaturizer(
    model_config_key="UniMol-V1-Base",      # Links to an entry in UNIMOL_BASE_CONFIGS
    remove_hs_override=False,              # Optionally override the 'remove_hs' from the base config
    unimol_kwargs_override={'use_gpu': True} # Pass additional args to unimol_tools.UniMolRepr
)
caffeine_smiles = "CN1C=NC2=C1C(=O)N(C(=O)N2C)C"
custom_cls_embedding = custom_cls_featurizer.featurize(caffeine_smiles)

if custom_cls_embedding is not None:
    print(f"Caffeine CLS Rep Shape (direct init): {custom_cls_embedding.shape}")
    # Expected: (512,) for "UniMol-V1-Base"
```
When instantiating directly:
-   `model_config_key` refers to a key in the `UNIMOL_BASE_CONFIGS` dictionary within `polyglotmol.representations.spatial.unimol`. This determines the base UniMol model settings (like `unimol_tools_model_name`, `unimol_tools_model_size`, and the default `remove_hs`).
-   `remove_hs_override` (Optional[bool]): Allows you to explicitly set `remove_hs` for this instance, overriding the default from the chosen base configuration.
-   `unimol_kwargs_override` (Optional[Dict[str, Any]]): A dictionary of additional arguments to pass directly to the `unimol_tools.UniMolRepr` constructor (e.g., `{'use_gpu': True}`).

---
## Output Structure

Each UniMol featurizer variant in PolyglotMol returns a single NumPy array (`np.float32`) for a successfully processed molecule, or `None` if featurization fails. The specifics are detailed below:

| Featurizer Class                          | Output Type         | Shape        | N       | D (embedding dimension)     | Description                                                                                             |
| :---------------------------------------- | :------------------ | :----------- | :-------------------------- | :-------------------------- | :------------------------------------------------------------------------------------------------------ |
| UniMolCLSFeaturizer                    | 1D NumPy array      | `(D,)`       | -                         | From Uni-Mol model          | This vector represents the entire molecule.                                                           |
| UniMolAtomicCoordsFeaturizer           | 2D NumPy array      | `(N, 3)`     | Number of atoms            | Fixed (3 for XYZ coords)    | Each row contains the (X, Y, Z) coordinates for an atom. Returns shape `(0, 3)` if no atoms.           |
| UniMolAtomicReprsFeaturizer             | 2D NumPy array      | `(N, D)`     | Number of atoms             | From Uni-Mol atomic reprs   | Each row is an atom's embedding vector. Returns shape `(0, D)` if no atoms.                            |

**Important Notes on Output:**
-   The order of atoms in outputs from `UniMolAtomicCoordsFeaturizer` and `UniMolAtomicReprsFeaturizer` generally corresponds to their order after internal processing (including potential hydrogen manipulation) and conformer generation by `unimol_tools`.
-   If featurization fails for a specific molecule (e.g., `unimol_tools` cannot process it), the `featurize` method will return `None` for that item (in batch mode, the corresponding list element will be `None`).

You can inspect the expected output format using the `get_output_info()` method on an instantiated featurizer:
```python
# Assuming cls_featurizer is an instance of UniMolCLSFeaturizer
# for the "UniMol-CLS-unimolv2-84m-WithHs" configuration
# output_type, shape_desc = cls_featurizer.get_output_info()
print(f"Output Type for CLS Featurizer: {output_type}")
# Expected: <class 'numpy.ndarray'>
# print(f"Expected Shape for CLS Featurizer: {shape_desc}")
# Expected: (512,) (or the specific dimension of the 84M model)

# Assuming coords_featurizer is an instance of UniMolAtomicCoordsFeaturizer
# output_type_coords, shape_desc_coords = coords_featurizer.get_output_info()
print(f"Output Type for Coords Featurizer: {output_type_coords}")
# Expected: <class 'numpy.ndarray'>
print(f"Expected Shape for Coords Featurizer: {shape_desc_coords}")
# Expected: (None, 3) (None because number of atoms is variable)
```

---
## Available Pre-registered Configurations

PolyglotMol uses a set of base Uni-Mol model configurations defined in {py:data}`polyglotmol.representations.spatial.unimol.UNIMOL_BASE_CONFIGS`. For each entry in this dictionary, three featurizer variants are automatically registered: one for CLS representations, one for atomic coordinates, and one for atomic representations.


PolyglotMol registers specific featurizer variants based on the `UNIMOL_BASE_CONFIGS` defined in {py:mod}`polyglotmol.representations.spatial.unimol`. The registered names follow the pattern: `UniMol-[Type]-[ToolModelName]-[ToolModelSizeIfAny]-[HsHandling]`.

-   **`[Type]`**: `CLS`, `AtomicCoords`, `AtomicReprs`.
-   **`[ToolModelName]`**: e.g., `unimolv1`, `unimolv2`.
-   **`[ToolModelSizeIfAny]`**: e.g., `84m`, `1.1b` (omitted for `unimolv1`).
-   **`[HsHandling]`**: `WithHs` (hydrogens kept) or `NoHs` (hydrogens removed).

The table below lists the registered keys and their underlying `unimol_tools` parameters.

| Registered Featurizer Key                     | Output Type      | `unimol_tools` `model_name` | `unimol_tools` `model_size` | `remove_hs` | Assumed Output Dim. (D) |
| :-------------------------------------------- | :--------------- | :-------------------------- | :-------------------------- | :---------- | :------------------------ |
| `UniMol-CLS-unimolv1-WithHs`                  | CLS              | `unimolv1`                  | N/A                         | `False`     | 512                       |
| `UniMol-AtomicCoords-unimolv1-WithHs`         | Atomic Coords    | `unimolv1`                  | N/A                         | `False`     | 512 (for model context)   |
| `UniMol-AtomicReprs-unimolv1-WithHs`          | Atomic Reprs     | `unimolv1`                  | N/A                         | `False`     | 512                       |
| `UniMol-CLS-unimolv2-84m-WithHs`              | CLS              | `unimolv2`                  | `84m`                       | `False`     | 512                       |
| `UniMol-AtomicCoords-unimolv2-84m-WithHs`     | Atomic Coords    | `unimolv2`                  | `84m`                       | `False`     | 512 (for model context)   |
| `UniMol-AtomicReprs-unimolv2-84m-WithHs`      | Atomic Reprs     | `unimolv2`                  | `84m`                       | `False`     | 512                       |
| `UniMol-CLS-unimolv2-84m-NoHs`                | CLS              | `unimolv2`                  | `84m`                       | `True`      | 512                       |
| `UniMol-AtomicCoords-unimolv2-84m-NoHs`       | Atomic Coords    | `unimolv2`                  | `84m`                       | `True`      | 512 (for model context)   |
| `UniMol-AtomicReprs-unimolv2-84m-NoHs`        | Atomic Reprs     | `unimolv2`                  | `84m`                       | `True`      | 512                       |
| `UniMol-CLS-unimolv2-164m-WithHs`             | CLS              | `unimolv2`                  | `164m`                      | `False`     | 768                       |
| `UniMol-AtomicCoords-unimolv2-164m-WithHs`    | Atomic Coords    | `unimolv2`                  | `164m`                      | `False`     | 768 (for model context)   |
| `UniMol-AtomicReprs-unimolv2-164m-WithHs`     | Atomic Reprs     | `unimolv2`                  | `164m`                      | `False`     | 768                       |
| `UniMol-CLS-unimolv2-164m-NoHs`               | CLS              | `unimolv2`                  | `164m`                      | `True`      | 768                       |
| `UniMol-AtomicCoords-unimolv2-164m-NoHs`      | Atomic Coords    | `unimolv2`                  | `164m`                      | `True`      | 768 (for model context)   |
| `UniMol-AtomicReprs-unimolv2-164m-NoHs`       | Atomic Reprs     | `unimolv2`                  | `164m`                      | `True`      | 768                       |
| `UniMol-CLS-unimolv2-310m-WithHs`             | CLS              | `unimolv2`                  | `310m`                      | `False`     | 1024                      |
| `UniMol-AtomicCoords-unimolv2-310m-WithHs`    | Atomic Coords    | `unimolv2`                  | `310m`                      | `False`     | 1024 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-310m-WithHs`     | Atomic Reprs     | `unimolv2`                  | `310m`                      | `False`     | 1024                      |
| `UniMol-CLS-unimolv2-310m-NoHs`               | CLS              | `unimolv2`                  | `310m`                      | `True`      | 1024                      |
| `UniMol-AtomicCoords-unimolv2-310m-NoHs`      | Atomic Coords    | `unimolv2`                  | `310m`                      | `True`      | 1024 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-310m-NoHs`       | Atomic Reprs     | `unimolv2`                  | `310m`                      | `True`      | 1024                      |
| `UniMol-CLS-unimolv2-570m-WithHs`             | CLS              | `unimolv2`                  | `570m`                      | `False`     | 1280                      |
| `UniMol-AtomicCoords-unimolv2-570m-WithHs`    | Atomic Coords    | `unimolv2`                  | `570m`                      | `False`     | 1280 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-570m-WithHs`     | Atomic Reprs     | `unimolv2`                  | `570m`                      | `False`     | 1280                      |
| `UniMol-CLS-unimolv2-570m-NoHs`               | CLS              | `unimolv2`                  | `570m`                      | `True`      | 1280                      |
| `UniMol-AtomicCoords-unimolv2-570m-NoHs`      | Atomic Coords    | `unimolv2`                  | `570m`                      | `True`      | 1280 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-570m-NoHs`       | Atomic Reprs     | `unimolv2`                  | `570m`                      | `True`      | 1280                      |
| `UniMol-CLS-unimolv2-1.1b-WithHs`             | CLS              | `unimolv2`                  | `1.1b`                      | `False`     | 2048                      |
| `UniMol-AtomicCoords-unimolv2-1.1b-WithHs`    | Atomic Coords    | `unimolv2`                  | `1.1b`                      | `False`     | 2048 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-1.1b-WithHs`     | Atomic Reprs     | `unimolv2`                  | `1.1b`                      | `False`     | 2048                      |
| `UniMol-CLS-unimolv2-1.1b-NoHs`               | CLS              | `unimolv2`                  | `1.1b`                      | `True`      | 2048                      |
| `UniMol-AtomicCoords-unimolv2-1.1b-NoHs`      | Atomic Coords    | `unimolv2`                  | `1.1b`                      | `True`      | 2048 (for model context)  |
| `UniMol-AtomicReprs-unimolv2-1.1b-NoHs`       | Atomic Reprs     | `unimolv2`                  | `1.1b`                      | `True`      | 2048                      |


The registered names follow this pattern:
`UniMol-[Type]-[UniMolToolModelName]-[UniMolToolModelSizeIfAny]-[HsHandling]`

Where:
-   `[Type]` is one of `CLS`, `AtomicCoords`, or `AtomicReprs`.
-   `[UniMolToolModelName]` is typically `unimolv1` or `unimolv2` (derived from `unimol_tools_model_name` in the base config).
-   `[UniMolToolModelSizeIfAny]` is the size like `84m`, `1.1b` (derived from `unimol_tools_model_size` in the base config; omitted if not applicable, e.g., for `unimolv1`).
-   `[HsHandling]` is `WithHs` (if the configuration results in `remove_hs: False`) or `NoHs` (if `remove_hs: True`).

**Example Derivation:**
If `UNIMOL_BASE_CONFIGS` has an entry keyed as `"UniMol-V2-84M-Base"` with `{"unimol_tools_model_name": "unimolv2", "unimol_tools_model_size": "84m", "remove_hs": False, ...}`, the following featurizer keys will be registered:
-   CLS Featurizer Key: `UniMol-CLS-unimolv2-84m-WithHs`
-   Atomic Coordinates Featurizer Key: `UniMol-AtomicCoords-unimolv2-84m-WithHs`
-   Atomic Representations Featurizer Key: `UniMol-AtomicReprs-unimolv2-84m-WithHs`

### Base Uni-Mol Configurations (`UNIMOL_BASE_CONFIGS`)

The following table details the base configurations defined in PolyglotMol. Each of these generates the three featurizer variants mentioned above.

| PolyglotMol Base Config Key   | `unimol_tools` `model_name` | `unimol_tools` `model_size` | Default `remove_hs` | Assumed Output Dim. (D) | `data_type` |
| :---------------------------- | :-------------------------- | :-------------------------- | :-------------------- | :------------------------ | :---------- |
| `UniMol-V1-Base`              | `unimolv1`                  | N/A                         | `False`               | 512                       | `molecule`  |
| `UniMol-V2-84M-Base`          | `unimolv2`                  | `84m`                       | `False`               | 512                       | `molecule`  |
| `UniMol-V2-164M-Base`         | `unimolv2`                  | `164m`                      | `False`               | 768                       | `molecule`  |
| `UniMol-V2-310M-Base`         | `unimolv2`                  | `310m`                      | `False`               | 1024                      | `molecule`  |
| `UniMol-V2-570M-Base`         | `unimolv2`                  | `570m`                      | `False`               | 1280                      | `molecule`  |
| `UniMol-V2-1.1B-Base`         | `unimolv2`                  | `1.1b`                      | `False`               | 2048                      | `molecule`  |
| `UniMol-V1-Base-NoHs`         | `unimolv1`                  | N/A                         | `True`                | 512                       | `molecule`  |
| `UniMol-V2-84M-Base-NoHs`     | `unimolv2`                  | `84m`                       | `True`                | 512                       | `molecule`  |
| `UniMol-V2-164M-Base-NoHs`    | `unimolv2`                  | `164m`                      | `True`                | 768                       | `molecule`  |
| `UniMol-V2-310M-Base-NoHs`    | `unimolv2`                  | `310m`                      | `True`                | 1024                      | `molecule`  |
| `UniMol-V2-570M-Base-NoHs`    | `unimolv2`                  | `570m`                      | `True`                | 1280                      | `molecule`  |
| `UniMol-V2-1.1B-Base-NoHs`    | `unimolv2`                  | `1.1b`                      | `True`                | 2048                      | `molecule`  |

**Note on "Assumed Output Dim. (D)":** These are indicative values based on common model architectures. The actual embedding dimension is determined by the specific pre-trained model loaded by `unimol_tools`. PolyglotMol's `UniMol...Featurizer` classes attempt to infer this dimension at runtime if not specified or if the config value is a placeholder.

To see all registered UniMol featurizer keys currently available in your PolyglotMol installation (which depend on `unimol_tools` being installed and detectable), you can use:
```python
from polyglotmol.representations import list_available_featurizers

all_featurizers = list_available_featurizers()
# Filter for UniMol specific featurizers based on their naming convention
unimol_keys = [key for key in all_featurizers if key.startswith("UniMol-")] 
print("\\nRegistered UniMol Featurizer Keys:")
for key in sorted(unimol_keys):
    print(f"- {key}")
```

---
## API Reference

For detailed information on the UniMol featurizer classes:
-   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolCLSFeaturizer`
-   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicCoordsFeaturizer`
-   {py:class}`~polyglotmol.representations.spatial.unimol.UniMolAtomicReprsFeaturizer`
-   (Internal base class for UniMol featurizers) {py:class}`polyglotmol.representations.spatial.unimol.BaseUniMolFeaturizer`

See also the full API documentation page for this module:
{doc}`/api/representations/spatial/unimol`

---
## External References

-   **Uni-Mol Project:** [dptech-corp/Uni-Mol on GitHub](https://github.com/dptech-corp/Uni-Mol) (includes links to original papers and the `unimol_tools` library).
-   **`unimol_tools` Package:** Typically installed via `pip`. Check [PyPI](https://pypi.org/project/unimol-tools/) for the latest version.
-   **PyTorch:** [pytorch.org](https://pytorch.org/)
-   **Hugging Face Hub:** [huggingface.co/docs/huggingface_hub](https://huggingface.co/docs/huggingface_hub)

---
```{toctree}
:maxdepth: 1
:hidden:
```
